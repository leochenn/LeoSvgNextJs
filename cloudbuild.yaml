steps:
  # 1. 构建 Docker 镜像
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/my-nextjs-repo/${_SERVICE_NAME}:$SHORT_SHA' # <-- 修改 'my-nextjs-repo'
      - '.'

  # 2. 将镜像推送到 Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/my-nextjs-repo/${_SERVICE_NAME}:$SHORT_SHA' # <-- 修改 'my-nextjs-repo'

  # 3. 部署到 Cloud Run
  - name: 'gcr.io/google-cloud-sdk/gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}' # 这是你的服务名称
      - '--image'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/my-nextjs-repo/${_SERVICE_NAME}:$SHORT_SHA' # <-- 修改 'my-nextjs-repo'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated' # 允许公开访问，如果是私有服务请移除此行
      # 如果需要环境变量, 在这里添加:
      - '--set-env-vars=GEMINI_API_KEY=AIzaSyCw3uJC89mF5h0KUahOPvgx21FU69WZ1hA,NEXT_PUBLIC_SUPABASE_URL=https://njunlwwhxxxpwtrglngb.supabase.co,NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qdW5sd3doeHh4cHd0cmdsbmdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDMzNDMsImV4cCI6MjA4MTAxOTM0M30.ac3d27DQVWuI7HHJA0zc6Irfc1FlSmzQ8ApWxuQ5ouQ'

substitutions:
  _SERVICE_NAME: 'my-nextjs-repo' # <-- 修改成您的服务名
  _REGION: 'us-west2'         # <-- 修改成您选择的区域

images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/my-nextjs-repo/${_SERVICE_NAME}:$SHORT_SHA' # <-- 修改 'my-nextjs-repo'
